<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All the Fishes</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
</head>
<body>
    
    <script>
        // the app
        const app = new PIXI.Application({
            width: 640,
            height: 480,
            backgroundColor:0x2A8BB5,
        });
        
        // give us the view
        document.body.appendChild(app.view);

        // load fishes
        const yellowFish = PIXI.Sprite.from("images/yellow-fish.png");
        const parrotFish = PIXI.Sprite.from("images/parrot-fish.png");
        const redFish = PIXI.Sprite.from("images/red-fish.png");
        const byFish = PIXI.Sprite.from("images/by-fish.png");

        //load swimming fish
        const swimFish = PIXI.Sprite.from("images/thefish.png");

        //load school
        const cuteFish1 = PIXI.Sprite.from("images/cute-fish.png");
        const cuteFish2 = PIXI.Sprite.from("images/cute-fish.png");
        const cuteFish3 = PIXI.Sprite.from("images/cute-fish.png");
        const cuteFish4 = PIXI.Sprite.from("images/cute-fish.png");
        const cuteFish5 = PIXI.Sprite.from("images/cute-fish.png");
        const cuteFish6 = PIXI.Sprite.from("images/cute-fish.png");
        const cuteFish7 = PIXI.Sprite.from("images/cute-fish.png");

        //load bubbles
        const bubble1 = PIXI.Sprite.from("images/bubble.png");
        const bubble2 = PIXI.Sprite.from("images/bubble.png");
        const bubble3 = PIXI.Sprite.from("images/bubble.png");
        const bubble4 = PIXI.Sprite.from("images/bubble.png");
        const bubble5 = PIXI.Sprite.from("images/bubble.png");
        const bubble6 = PIXI.Sprite.from("images/bubble.png");

        // load background
        const coralReef = PIXI.Sprite.from("images/coral-reef.png");

        // filter
        // const radius = 100;
        // const blurSize = 32;
        // const circle = new PIXI.Graphics().beginFill(0xFF0000).drawCircle(radius + blurSize, radius + blurSize, radius).endFill();
        // circle.filters = [new PIXI.filters.BlurFilter(blurSize)];
        // const bounds = new PIXI.Rectangle(0, 0, (radius + blurSize) * 2, (radius + blurSize) * 2);
        // const texture = app.renderer.generateTexture(circle, PIXI.SCALE_MODES.NEAREST, 1, bounds);
        // const focus = new PIXI.Sprite(texture);

        // place background
        coralReef.anchor.set(0.5);
        coralReef.scale.set(.7);
        coralReef.position.set(320, 240);

        // scale + position bubbles
        const bubbles = [bubble1, bubble2, bubble3, bubble4, bubble5, bubble6]

        bubbles.forEach(bubble => {
            bubble.scale.set(.15);
            bubble.anchor.set(0.5);
            bubble.position.set(Math.random() * 640, Math.random() * 480);
            bubble.scale.set(Math.random() / 5);
        })

        // set anchor, scale, and place 4 main fish
        yellowFish.interactive = true;

        yellowFish.anchor.set(0.5);
        parrotFish.anchor.set(0.5);
        redFish.anchor.set(0.5);
        byFish.anchor.set(0.5);

        yellowFish.scale.set(.6);
        parrotFish.scale.set(.4);
        redFish.scale.set(.5);
        byFish.scale.set(.6);

        yellowFish.scale.x *= -1;
        byFish.scale.x *= -1;

        yellowFish.position.set(100, 200);
        parrotFish.position.set(200, 300);
        redFish.position.set(350, 200);
        byFish.position.set(500, 400);

        // draggable event listeners
        let dragging = false;
        offsetX = 0;
        offsetY = 0;

        yellowFish.on("pointerdown", (e) => {
            dragging = true;
            offsetX = yellowFish.x - e.data.global.x;
            offsetY = yellowFish.y - e.data.global.y;
        })

        yellowFish.on("pointermove", (e) => {
            if (dragging) {
                yellowFish.x = e.data.global.x + offsetX;
                yellowFish.y = e.data.global.y + offsetY;
            }
        });

        yellowFish.on("pointerup", (e) => {
            dragging = false;
        });

        // position swim fish
        swimFish.anchor.set(0.5);
        swimFish.scale.set(-.1, .1);
        swimFish.position.set(200,200);

        // create container to hold school of fish
        const fishContainer = new PIXI.Container();
        fishContainer.position.set(0,0);

        // scale + position school of fish
        const cuteFish = [cuteFish1, cuteFish2, cuteFish3, cuteFish4, cuteFish5, cuteFish6, cuteFish7];
        
        cuteFish.forEach(fish => {
            fish.scale.set(-0.05, .05);
            fish.position.set(Math.random() * 100 + 100, Math.random() * 100 + 100);
            fishContainer.addChild(fish);
        })

        // add sprites to stage ( in correct order )
        app.stage.addChild(coralReef);

        app.stage.addChild(fishContainer);

        app.stage.addChild(bubble1);
        app.stage.addChild(bubble2);
        app.stage.addChild(bubble3);
        app.stage.addChild(bubble4);
        app.stage.addChild(bubble5);
        app.stage.addChild(bubble6);

        app.stage.addChild(yellowFish);
        app.stage.addChild(parrotFish);
        app.stage.addChild(redFish);
        app.stage.addChild(byFish);

        app.stage.addChild(swimFish);

        // app.stage.addChild(focus);
        // coralReef.mask = focus;

        // app.stage.interactive = true;
        // app.stage.on('mousemove', pointerMove);

        // function pointerMove(event) {
        //     focus.position.x = event.data.global.x - focus.width / 2;
        //     focus.position.y = event.data.global.y - focus.height / 2;
        // }
        let forwards = true;

        function makeButton() {
            // create container
            let ourButton = new PIXI.Container();
            ourButton.interactive = true;

            // create button body
            let buttonBody = PIXI.Sprite.from("images/button.png");
            ourButton.addChild(buttonBody);
            buttonBody.scale.set(.8);
            buttonBody.anchor.set(.5);

            let buttonText = new PIXI.Text('Change the swimming\nfish\'s color');
            buttonText.scale.set(.5);
            buttonText.anchor.set(.5);
            buttonText.style.align = "center";
            buttonText.position.set(buttonBody.width / 2, buttonBody.height / 2);
            ourButton.addChild(buttonText);

            ourButton.label = buttonText;
            ourButton.body = buttonBody;

            // click listener
            ourButton.on("pointertap", (e) => {
                swimFish.tint = 0xFFFFFF * Math.random();
            });
            
            // hover listener
            ourButton.on("pointerover", (e) => {
                buttonBody.tint = 0xF84EAE;
                buttonText.style.fill = 0xFFFFFF;
                
            });
            ourButton.on("pointerout", (e) => {
                buttonBody.tint = 0xFFFFFF;
                buttonText.style.fill = 0x000000;
            });

            return ourButton;
        }

        let button = makeButton();
        button.position.set(520, 50);
        app.stage.addChild(button);

        function makeSlider() {
            // create container
            let ourButton = new PIXI.Container();
            ourButton.interactive = true;
            
            //value from 0.0 to 1.0
            ourButton.value = 0;

            // the track
            let theTrack = new PIXI.Graphics();
            theTrack.beginFill(0xFA80C5);
            theTrack.drawRect(0, -10, 300, 10);
            ourButton.addChild(theTrack);

            // the slide
            let theSlide = PIXI.Sprite.from("images/star.svg");
            theSlide.interactive = true;
            theSlide.anchor.set(.5);
            theSlide.scale.set(.5);
            theSlide.position.set(10, -3);

            ourButton.addChild(theSlide);

            theSlide.dragging = false;

            theSlide.on("pointerdown", (e) => {
                theSlide.dragging = true;
            });

            theSlide.on("pointermove", (e) => {
                if (theSlide.dragging) {
                    let newX = e.data.global.x - ourButton.getGlobalPosition().x;
                    let newY = e.data.global.y - ourButton.getGlobalPosition().y;

                    if (newX > theTrack.width) newX = theTrack.width;
                    if (newX < 0) newX = 0;

                    ourButton.value = newX / theTrack.width;
                    theSlide.x = newX;
                    swimFish.rotation = (ourButton.value * 10);
                }
            });
            
            theSlide.on("pointerup", (e) => {
                theSlide.dragging = false;
            })

            theSlide.on("pointerupoutside", (e) => {
                theSlide.dragging = false;
            })

            return ourButton;
        }

        let slider = makeSlider();
        slider.position.set(30, 40);
        app.stage.addChild(slider);

        // loop de loop and pull, and your shoe's all lookin good
        let loop = () => {
            // make a series of diff wobbles
            let time = Date.now();
            let wobble = Math.sin(time / 1000) * 10;
            let wobble2 = Math.sin(time / 500) * 5;
            let wobble3 = Math.sin(time / 200);

            // apply wobbles to main fish on different axes
            // yellowFish.y = 100 + wobble;
            parrotFish.y = 300 + wobble2;

            redFish.x = 400 + wobble;
            byFish.x = 500 + wobble2;
            byFish.y = 400 + wobble;

            // swim fish stuff
            swimFish.y = 200 + wobble;
            if (forwards) {
                swimFish.x += 1;
            } else {
                swimFish.x -= 1;
            }

            // move school
            fishContainer.x += 1;
            fishContainer.y += wobble3;

            if (fishContainer.x > 640) {
                fishContainer.x = -200;
                fishContainer.y = Math.random() * 280;

                cuteFish.forEach(fish => {
                    fish.position.set(Math.random() * 100 + 100, Math.random() * 100 + 100);
                })
            }

            // make swimfish turn around
            if (swimFish.x > 640) {
                swimFish.x = 640;
                swimFish.scale.x *= -1;
                forwards = false;
            }

            if (swimFish.x < 0) {
                swimFish.x = 0;
                swimFish.scale.x *= -1;
                forwards = true;
            }

            // move bubbles
            bubbles.forEach((bubble) => {
                bubble.position.y -= 1;

                if (bubble.position.y < 0) {
                    bubble.position.y = 500;
                    bubble.position.x = Math.random() * 640;
                    bubble.scale.set(Math.random() / 5);
                }
            })

            requestAnimationFrame(loop);
        }

        loop();

    </script>

</body>
</html>