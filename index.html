<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All the Fishes</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
    <style>

        body {
            height: 100vh;
            display: grid;
        }

        canvas {
            place-self: center;
        }
        
    </style>
</head>
<body>
    
    <script>
        // the app
        const app = new PIXI.Application({
            width: 640,
            height: 480,
            backgroundColor:0x2A8BB5,
        });
        
        // give us the view
        document.body.appendChild(app.view);

        // load fishes
        const yellowFish = PIXI.Sprite.from("images/yellow-fish.png");
        const parrotFish = PIXI.Sprite.from("images/parrot-fish.png");
        const redFish = PIXI.Sprite.from("images/red-fish.png");
        const byFish = PIXI.Sprite.from("images/by-fish.png");

        // //load swimming fish
        // const swimFish = PIXI.Sprite.from("images/thefish.png");

        // //load school
        // const cuteFish1 = PIXI.Sprite.from("images/cute-fish.png");
        // const cuteFish2 = PIXI.Sprite.from("images/cute-fish.png");
        // const cuteFish3 = PIXI.Sprite.from("images/cute-fish.png");
        // const cuteFish4 = PIXI.Sprite.from("images/cute-fish.png");
        // const cuteFish5 = PIXI.Sprite.from("images/cute-fish.png");
        // const cuteFish6 = PIXI.Sprite.from("images/cute-fish.png");
        // const cuteFish7 = PIXI.Sprite.from("images/cute-fish.png");

        //load bubbles
        const bubble1 = PIXI.Sprite.from("images/bubble.png");
        const bubble2 = PIXI.Sprite.from("images/bubble.png");
        const bubble3 = PIXI.Sprite.from("images/bubble.png");
        const bubble4 = PIXI.Sprite.from("images/bubble.png");
        const bubble5 = PIXI.Sprite.from("images/bubble.png");
        const bubble6 = PIXI.Sprite.from("images/bubble.png");

        // load background
        const coralReef = PIXI.Sprite.from("images/coral-reef.png");

        // place background
        coralReef.anchor.set(0.5);
        coralReef.scale.set(.7);
        coralReef.position.set(320, 240);

        // scale + position bubbles
        const bubbles = [bubble1, bubble2, bubble3, bubble4, bubble5, bubble6]

        bubbles.forEach(bubble => {
            bubble.anchor.set(0.5);
            bubble.position.set(Math.random() * 640, 500);
            bubble.scale.set(Math.random() / 5);
        })

        // set anchor, scale, and place 4 main fish

        yellowFish.anchor.set(0.5);
        parrotFish.anchor.set(0.5);
        redFish.anchor.set(0.5);
        byFish.anchor.set(0.5);

        yellowFish.scale.set(.6);
        parrotFish.scale.set(.4);
        redFish.scale.set(.5);
        byFish.scale.set(.6);

        yellowFish.scale.x *= -1;
        byFish.scale.x *= -1;

        yellowFish.position.set(200, 150);
        parrotFish.position.set(300, 300);
        redFish.position.set(350, 200);
        byFish.position.set(500, 400);

        // draggable event listeners
        // let dragging = false;
        // offsetX = 0;
        // offsetY = 0;

        // yellowFish.on("pointerdown", (e) => {
        //     dragging = true;
        //     offsetX = yellowFish.x - e.data.global.x;
        //     offsetY = yellowFish.y - e.data.global.y;
        // })

        // yellowFish.on("pointermove", (e) => {
        //     if (dragging) {
        //         yellowFish.x = e.data.global.x + offsetX;
        //         yellowFish.y = e.data.global.y + offsetY;
        //     }
        // });

        // yellowFish.on("pointerup", (e) => {
        //     dragging = false;
        // });

        // position swim fish
        // swimFish.anchor.set(0.5);
        // swimFish.scale.set(-.1, .1);
        // swimFish.position.set(200,200);

        // create container to hold school of fish
        // const fishContainer = new PIXI.Container();
        // fishContainer.position.set(0,0);

        // // scale + position school of fish
        // const cuteFish = [cuteFish1, cuteFish2, cuteFish3, cuteFish4, cuteFish5, cuteFish6, cuteFish7];
        
        // cuteFish.forEach(fish => {
        //     fish.scale.set(-0.05, .05);
        //     fish.position.set(Math.random() * 100 + 100, Math.random() * 100 + 100);
        //     fishContainer.addChild(fish);
        // })

        // add sprites to stage ( in correct order )
        app.stage.addChild(coralReef);

        // app.stage.addChild(fishContainer);

        app.stage.addChild(bubble1);
        app.stage.addChild(bubble2);
        app.stage.addChild(bubble3);
        app.stage.addChild(bubble4);
        app.stage.addChild(bubble5);
        app.stage.addChild(bubble6);

        app.stage.addChild(yellowFish);
        app.stage.addChild(parrotFish);
        app.stage.addChild(redFish);
        app.stage.addChild(byFish);

        // app.stage.addChild(swimFish);

        // let forwards = true;

        // function makeButton() {
        //     // create container
        //     let ourButton = new PIXI.Container();
        //     ourButton.interactive = true;

        //     // create button body
        //     let buttonBody = PIXI.Sprite.from("images/button.png");
        //     ourButton.addChild(buttonBody);
        //     buttonBody.scale.set(.8);
        //     buttonBody.anchor.set(.5);

        //     let buttonText = new PIXI.Text('Change the swimming\nfish\'s color');
        //     buttonText.scale.set(.5);
        //     buttonText.anchor.set(.5);
        //     buttonText.style.align = "center";
        //     buttonText.position.set(buttonBody.width / 2, buttonBody.height / 2);
        //     ourButton.addChild(buttonText);

        //     ourButton.label = buttonText;
        //     ourButton.body = buttonBody;

        //     // click listener
        //     ourButton.on("pointertap", (e) => {
        //         swimFish.tint = 0xFFFFFF * Math.random();
        //     });
            
        //     // hover listener
        //     ourButton.on("pointerover", (e) => {
        //         buttonBody.tint = 0xF84EAE;
        //         buttonText.style.fill = 0xFFFFFF;
                
        //     });
        //     ourButton.on("pointerout", (e) => {
        //         buttonBody.tint = 0xFFFFFF;
        //         buttonText.style.fill = 0x000000;
        //     });

        //     return ourButton;
        // }

        // let button = makeButton();
        // button.position.set(520, 50);
        // app.stage.addChild(button);

        // function makeSlider() {
        //     // create container
        //     let ourButton = new PIXI.Container();
        //     ourButton.interactive = true;
            
        //     //value from 0.0 to 1.0
        //     ourButton.value = 0;

        //     // the track
        //     let theTrack = new PIXI.Graphics();
        //     theTrack.beginFill(0xFA80C5);
        //     theTrack.drawRect(0, -10, 300, 10);
        //     ourButton.addChild(theTrack);

        //     // the slide
        //     let theSlide = PIXI.Sprite.from("images/star.svg");
        //     theSlide.interactive = true;
        //     theSlide.anchor.set(.5);
        //     theSlide.scale.set(.5);
        //     theSlide.position.set(10, -3);

        //     ourButton.addChild(theSlide);

        //     theSlide.dragging = false;

        //     theSlide.on("pointerdown", (e) => {
        //         theSlide.dragging = true;
        //     });

        //     theSlide.on("pointermove", (e) => {
        //         if (theSlide.dragging) {
        //             let newX = e.data.global.x - ourButton.getGlobalPosition().x;
        //             let newY = e.data.global.y - ourButton.getGlobalPosition().y;

        //             if (newX > theTrack.width) newX = theTrack.width;
        //             if (newX < 0) newX = 0;

        //             ourButton.value = newX / theTrack.width;
        //             theSlide.x = newX;
        //             swimFish.rotation = (ourButton.value * 10);
        //         }
        //     });
            
        //     theSlide.on("pointerup", (e) => {
        //         theSlide.dragging = false;
        //     })

        //     theSlide.on("pointerupoutside", (e) => {
        //         theSlide.dragging = false;
        //     })

        //     return ourButton;
        // }

        // let slider = makeSlider();
        // slider.position.set(30, 40);
        // app.stage.addChild(slider);

        

        // time to animate
        let Animate = {};

        Animate.to = function(obj,end) {
            return new Promise( (resolve,reject) => {

                let start = {
                    x : obj.x,
                    y : obj.y
                }

                if (end.duration == undefined) end.duration = 0;
                if (end.easing == undefined) end.easing = Animate.linear; 

                var startTime = Date.now();

                function loop() {

                    let ticker = Date.now() - startTime;
                    let delta = ticker/end.duration;
                    let ease = end.easing(delta);

                    if (delta >= 1 || end.duration === 0) {
                        obj.x = end.x;
                        obj.y = end.y;
                        
                        resolve();
                        return;
                    }

                    let lerp = (a, b, n) => {
                        return (1 - n) * a + n * b;
                    }

                    obj.x = lerp(start.x,end.x,ease);
                    obj.y = lerp(start.y,end.y,ease);

                    obj.animationID = requestAnimationFrame(loop);

                }
                cancelAnimationFrame(obj.animationID);
                loop();
            });

        };

        Animate.wobbleto = function(obj, end) {
            return new Promise((resolve, reject) => {
                let start = {
                    x: obj.x,
                    y: obj.y,
                }

                if (end.duration == undefined) end.duration = 0;
                if (end.easing == undefined) end.easing = Animate.linear; 

                var startTime = Date.now();

                function loop() {

                    let ticker = Date.now() - startTime;
                    let delta = ticker/end.duration;
                    let ease = end.easing(delta);

                    let wobble1 = Math.sin(ticker/200)*10;

                    if (delta >= 1 || end.duration === 0) {
                        obj.x = end.x;
                        obj.y = end.y;
                        
                        resolve();
                        return;
                    }

                    
                    let lerp = (a, b, n) => {
                        return (1 - n) * a + n * b;
                    }


                    obj.x = lerp(start.x,end.x,ease);
                    obj.y = lerp(start.y,end.y,ease);
                    obj.y += wobble1;
                    obj.animationID = requestAnimationFrame(loop);

                }
                cancelAnimationFrame(obj.animationID);
                loop();

            });
        }

        Animate.rotate = (obj, end) => {
            return new Promise( (resolve,reject) => {

                var start = {
                    angle: obj.angle,
                }

                if (end.duration == undefined) end.duration = 0;
                if (end.easing == undefined) end.easing = Animate.linear; 

                var startTime = Date.now();

                if (start.angle == end.angle) {
                    resolve();
                    return;
                }

                function loop() {

                    //Calculate our delta
                    let ticker = Date.now() - startTime;
                    let delta = ticker/end.duration;
                    let ease = end.easing(delta);

                    //If we're done, just snap to the end!
                    if (delta >= 1 || end.duration === 0) {
                        obj.angle = end.angle;
                        
                        resolve();
                        return;
                    }

                    //Interpolation function
                    let lerp = (a, b, n) => {
                        return (1 - n) * a + n * b;
                    }

                    obj.angle = lerp(start.angle,end.angle,ease);

                    obj.animationID = requestAnimationFrame(loop);

                }
                cancelAnimationFrame(obj.animationID);
                loop();
            });
        }

        Animate.scale = (obj, end) => {
            return new Promise( (resolve,reject) => {

                var start = {
                    sx: obj.scale.x,
                    sy: obj.scale.y
                }

                if (end.duration == undefined) end.duration = 0;
                if (end.easing == undefined) end.easing = Animate.linear; 

                var startTime = Date.now();

                function loop() {

                    //Calculate our delta
                    let ticker = Date.now() - startTime;
                    let delta = ticker/end.duration;
                    let ease = end.easing(delta);

                    //If we're done, just snap to the end!
                    if (delta >= 1 || end.duration === 0) {
                        obj.scale.x = end.sx;
                        obj.scale.y = end.sy;
                        
                        resolve();
                        return;
                    }

                    //Interpolation function
                    let lerp = (a, b, n) => {
                        return (1 - n) * a + n * b;
                    }

                    obj.scale.x = lerp(start.sx, end.sx, ease);
                    obj.scale.y = lerp(start.sy, end.sy, ease);

                    obj.animationID = requestAnimationFrame(loop);

                }
                cancelAnimationFrame(obj.animationID);
                loop();
            });
        }

        Animate.tint = (obj, end) => {
            return new Promise( (resolve,reject) => {

                var start = {
                    t: obj.tint,
                }

                if (end.duration == undefined) end.duration = 0;
                if (end.easing == undefined) end.easing = Animate.linear; 

                var startTime = Date.now();

                function loop() {

                    //Calculate our delta
                    let ticker = Date.now() - startTime;
                    let delta = ticker/end.duration;
                    let ease = end.easing(delta);

                    //If we're done, just snap to the end!
                    if (delta >= 1 || end.duration === 0) {
                        obj.tint = end.t;
                        
                        resolve();
                        return;
                    }

                    //Interpolation function
                    let lerp = (a, b, n) => {
                        return (1 - n) * a + n * b;
                    }

                    // https://gist.github.com/nikolas/b0cce2261f1382159b507dd492e1ceef

                    let sRed = (start.t & 0xff0000) >> 16;
                    let sGreen = (start.t & 0x00ff00) >> 8;
                    let sBlue = (start.t & 0x0000ff);

                    let eRed = (end.t & 0xff0000) >> 16;
                    let eGreen = (end.t &0x00ff00) >> 8;
                    let eBlue = (end.t & 0x0000ff);

                    let rRed = Math.round(lerp(sRed, eRed, ease));
                    let rGreen = Math.round(lerp(sGreen, eGreen, ease));
                    let rBlue = Math.round(lerp(sBlue, eBlue, ease));

                    obj.tint = (rRed << 16) + (rGreen << 8) + (rBlue | 0);

                    obj.animationID = requestAnimationFrame(loop);

                }
                cancelAnimationFrame(obj.animationID);
                loop();
            });
        }

        Animate.alpha = (obj, end) => {
            return new Promise( (resolve,reject) => {

                var start = {
                    a: obj.alpha,
                }

                if (end.duration == undefined) end.duration = 0;
                if (end.easing == undefined) end.easing = Animate.linear; 

                var startTime = Date.now();

                function loop() {

                    //Calculate our delta
                    let ticker = Date.now() - startTime;
                    let delta = ticker/end.duration;
                    let ease = end.easing(delta);

                    //If we're done, just snap to the end!
                    if (delta >= 1 || end.duration === 0) {
                        obj.alpha = end.a;
                        
                        resolve();
                        return;
                    }

                    //Interpolation function
                    let lerp = (a, b, n) => {
                        return (1 - n) * a + n * b;
                    }

                    obj.alpha = lerp(start.a, end.a, ease);

                    obj.animationID = requestAnimationFrame(loop);

                }
                cancelAnimationFrame(obj.animationID);
                loop();
            });
        }

        Animate.linear = (x) => x;

        Animate.from = async function(obj, end) {
            end.duration = 0;
            Animate.to(obj, end);
        }

        // easings
        Animate.stop = (obj) => {
            cancelAnimationFrame(obj.animationID);
        }

        Animate.easeIn  = (x) => x * x;

        Animate.easeOut = (x) => 1 - (1 - x) * (1 - x);

        Animate.easeInOut = (x) => x < 0.5 ? 2 * x * x : 1 - Math.pow(-2 * x + 2, 2) / 2;

        let moveYellowFish = async () => {
            Animate.from(yellowFish, {x: 200, y: 150});
            await Animate.to(yellowFish, {x: 200, y: 130, duration: 1500, easing: Animate.easeOut});
            await Animate.to(yellowFish, {x: 200, y: 150, duration: 1500, easing: Animate.easeInOut});
            moveYellowFish();
        }

        let doTheThing = async () => {
            await Animate.rotate(yellowFish, {angle: -90, duration: 500, easing:Animate.easeInOut});
            await Animate.to(yellowFish, {x: 200, y: 0, duration: 1000, easing:Animate.easeOut});
            await Animate.rotate(yellowFish, {angle: 90, duration: 500, easing:Animate.easeInOut});
            await Animate.to(yellowFish, {x: 200, y: 150, duration: 1500, easing:Animate.easeInOut});
            await Animate.rotate(yellowFish, {angle: 0, duration: 500, easing:Animate.easeInOut});
            moveYellowFish();
        }

        let moveParrotFish = async () => {
            await Animate.wobbleto(parrotFish, {x: 100, y: 300, duration: 2000, easing: Animate.linear});
            await Animate.scale(parrotFish, {sx: -.4, sy: .4, duration: 500, easing: Animate.easeIn});
            await Animate.wobbleto(parrotFish, {x: 300, y: 300, duration: 2000, easing: Animate.linear});
            await Animate.scale(parrotFish, {sx: .4, sy: .4, duration: 500, easing: Animate.easeIn});
            moveParrotFish();
        }

        let callRedFish = async (e) => {
            let posX = e.data.global.x;
            let posY = e.data.global.y;
            await Animate.wobbleto(redFish, {x: posX, y: posY, duration: 2000, easing: Animate.easeInOut});
            await Animate.scale(redFish, {sx: -.3, sy: .5, duration: 500, easing: Animate.easeIn});
            await Animate.scale(redFish, {sx: .5, sy: .5, duration: 500, easing: Animate.easeIn});
            moveRedFish();
        }

        let moveRedFish = async () => {
            await Animate.scale(redFish, {sx: .6, sy: .6, duration: 800, easing: Animate.easeOut});
            await Animate.scale(redFish, {sx: .5, sy: .5, duration: 500, easing: Animate.easeOut});
            moveRedFish();
        }

        let danceByFish = async () => {
            await Animate.tint(byFish, {t: 0x00ff00, duration: 3000});
            await Animate.rotate(byFish, {angle: 360, duration: 2000});
            await Animate.alpha(byFish, {a: 1, duration: 800});
            await Animate.tint(byFish, {t: 0xcc0000, duration: 3000});
            await Animate.rotate(byFish, {angle: -360, duration: 2000});
            await Animate.alpha(byFish, {a: .5, duration: 800});
            danceByFish();
        }

        let moveBubbles = async () => {
            bubbles.forEach(async (bubble) => {
                await Animate.to(bubble, {x: bubble.x, y: -100, duration: Math.random() * 4000 + 2000});
                bubble.position.set(Math.random() * 640, 500);
                bubble.scale.set(Math.random() / 5);
                moveBubbles();
            });   
        }

        yellowFish.interactive = true;
        coralReef.interactive = true;

        yellowFish.on("pointertap", () => {
            doTheThing();
        });

        coralReef.on("pointertap", (e) => {
            callRedFish(e);
        })

        moveYellowFish();
        moveParrotFish();
        moveRedFish();
        danceByFish();
        moveBubbles();

        



    </script>

</body>
</html>